require.define({"ep_comments_page/static/js/index.js": {"(module ep_comments_page/static/js/index.js)": function (require, exports, module) {"use strict";const _=require("underscore"),browser=require("ep_etherpad-lite/static/js/browser"),commentBoxes=require("ep_comments_page/static/js/commentBoxes"),commentIcons=require("ep_comments_page/static/js/commentIcons"),commentL10n=require("ep_comments_page/static/js/commentL10n"),events=require("ep_comments_page/static/js/copyPasteEvents"),moment=require("ep_comments_page/static/js/moment-with-locales.min"),newComment=require("ep_comments_page/static/js/newComment"),padcookie=require("ep_etherpad-lite/static/js/pad_cookie").padcookie,preCommentMark=require("ep_comments_page/static/js/preCommentMark"),getCommentIdOnFirstPositionSelected=events.getCommentIdOnFirstPositionSelected,hasCommentOnSelection=events.hasCommentOnSelection,Security=require("ep_etherpad-lite/static/js/security"),cssFiles=["ep_comments_page/static/css/comment.css","ep_comments_page/static/css/commentIcon.css"],UPDATE_COMMENT_LINE_POSITION_EVENT="updateCommentLinePosition",parseMultiline=e=>e&&(e=JSON.stringify(e),e.substr(1,e.length-2)),EpComments=function(e){this.container=null,this.padOuter=null,this.padInner=null,this.ace=e.ace;const t=document.location,n=t.port===""?t.protocol==="https:"?443:80:t.port,o=`${t.protocol}//${t.hostname}:${n}/comment`;this.padId=clientVars.padId,this.socket=io.connect(o,{query:`padId=${this.padId}`}),this.comments=[],this.commentReplies={},this.mapFakeComments=[],this.mapOriginalCommentsId=[],this.shouldCollectComment=!1,this.initDone=this.init(),this.preCommentMarker=preCommentMark.init(this.ace)};EpComments.prototype.init=async function(){const e=this;moment.locale(html10n.getLanguage()),this.findContainers(),this.insertContainers(),commentIcons.insertContainer();const[t,n]=await Promise.all([this.getComments(),this.getCommentReplies()]);$.isEmptyObject(t)||(this.setComments(t),this.collectComments()),$.isEmptyObject(n)||(this.commentReplies=n,this.collectCommentReplies()),this.commentRepliesListen(),this.commentListen(),this.pushComment("add",(o,s)=>{this.setComment(o,s),this.collectCommentsAfterSomeIntervalsOfTime()}),html10n.bind("localized",()=>{moment.locale([html10n.getLanguage(),"en"]),this.localizeExistingComments()}),$("#settings input, #skin-variant-full-width").on("change",o=>{this.setYofComments()}),this.padInner.contents().on(UPDATE_COMMENT_LINE_POSITION_EVENT,o=>{this.setYofComments()}),$(window).resize(_.debounce(()=>{this.setYofComments()},100)),$(".addComment").on("click",o=>{o.preventDefault(),this.displayNewCommentForm()}),this.container.parent().on("click",".comment-delete",async function(){const o=$(this).closest(".comment-container")[0].id;try{await e._send("deleteComment",{padId:e.padId,commentId:o,authorId:clientVars.userId})}catch(a){if(a.message!=="unauth")throw a;$.gritter.add({title:html10n.translations["ep_comments_page.error"]||"Error",text:html10n.translations["ep_comments_page.error.delete_unauth"]||"You cannot delete other users comments!",class_name:"error"});return}e.deleteComment(o);const i=$('iframe[name="ace_outer"]').contents().find('iframe[name="ace_inner"]'),c=`.${o}`,m=e.ace;m.callWithAce(a=>{const l=a.ace_getRepFromSelector(c,i);$.each(l,(r,d)=>{m.callWithAce(p=>{p.ace_performSelectionChange(d[0],d[1],!0),p.ace_setAttributeOnSelection("comment","comment-deleted")})})},"deleteCommentedSelection",!0)}),this.container.parent().on("click",".comment-edit",function(){const o=$(this).closest(".comment-container");o.addClass("editing");const s=e.findCommentText(o).last();if(s.siblings(".comment-edit-form").length===0){const i={};i.text=s.text();const c=$("#editCommentTemplate").tmpl(i);commentL10n.localize(c),s.before(c)}}),this.container.parent().on("click",".comment-edit-submit",async function(o){o.preventDefault(),o.stopPropagation();const s=$(this).closest(".comment-container"),i=$(this).closest(".comment-edit-form"),c=s.data("commentid"),m=i.find(".comment-edit-text").val(),a={};a.commentId=c,a.padId=clientVars.padId,a.commentText=m,a.authorId=clientVars.userId;try{await e._send("updateCommentText",a)}catch(l){if(l.message!=="unauth")throw l;$.gritter.add({title:html10n.translations["ep_comments_page.error"]||"Error",text:html10n.translations["ep_comments_page.error.edit_unauth"]||"You cannot edit other users comments!",class_name:"error"});return}i.remove(),s.removeClass("editing"),e.updateCommentBoxText(c,m),e.setCommentOrReplyNewText(c,m)}),this.container.parent().on("click",".comment-edit-cancel",function(o){o.preventDefault(),o.stopPropagation();const s=$(this).closest(".comment-container");e.findCommentText(s).last().siblings(".comment-edit-form").remove(),s.removeClass("editing")}),this.container.parent().on("change",".suggestion-checkbox",function(){const o=$(this).closest(".comment-container"),s=$(this).closest(".comment-reply");if($(this).is(":checked")){const i=o.data("commentid"),a=$('iframe[name="ace_outer"]').contents().find('iframe[name="ace_inner"]').contents().find(`.${i}`).html();s.find(".from-value").html(a),s.find(".suggestion").show()}else s.find(".suggestion").hide()}),this.container.parent().on("submit",".comment-changeTo-form",function(o){o.preventDefault();const s=e.getCommentData(),i=$(this).closest(".comment-container");s.commentId=i.data("commentid");const m=$('iframe[name="ace_outer"]').contents().find('iframe[name="ace_inner"]').contents(),a=i.hasClass("change-accepted");let l=a?$(this).find(".from-value").html():$(this).find(".to-value").html();const r=$(this).closest(".sidebar-comment").data("commentid");m.find(`.${r}:not(:first)`).html("");const d=m.find(`.${r}`).first();l=l.replace(/(?:\r\n|\r)/g,"<br />"),d.html(l),a?(e._send("revertChange",s),e.showChangeAsReverted(s.commentId)):(e._send("acceptChange",s),e.showChangeAsAccepted(s.commentId))}),this.container.parent().on("focus",".comment-content",function(o){$(this).closest(".new-comment").addClass("editing")}),this.container.parent().on("mouseleave",".comment-container",function(o){$(this).find(".suggestion-checkbox").prop("checked",!1),$(this).find(".new-comment").removeClass("editing")}),this.container.parent().on("submit",".new-comment",async function(o){o.preventDefault();const s=e.getCommentData();s.commentId=$(this).closest(".comment-container").data("commentid"),s.reply=$(this).find(".comment-content").val(),s.changeTo=$(this).find(".to-value").val()||null,s.changeFrom=$(this).find(".from-value").text()||null,$(this).trigger("reset_reply"),await e._send("addCommentReply",s);const i=await e.getCommentReplies();e.commentReplies=i,e.collectCommentReplies(),$('iframe[name="ace_outer"]').contents().find(".new-comment").removeClass("editing")}),this.container.parent().on("reset_reply",".new-comment",function(o){$(this).find(".comment-content").val(""),$(this).find(":focus").blur(),$(this).find(".to-value").val(""),$(this).find(".suggestion-checkbox").prop("checked",!1),$(this).removeClass("editing")}),this.container.parent().on("click",".btn-cancel-reply",function(o){$(this).closest(".new-comment").trigger("reset_reply")}),padcookie.getPref("comments")===!1?(this.padOuter.find("#comments, #commentIcons").removeClass("active"),$("#options-comments").attr("checked","unchecked"),$("#options-comments").attr("checked",!1)):$("#options-comments").attr("checked","checked"),$("#options-comments").on("change",()=>{const o=$("#options-comments").is(":checked");padcookie.setPref("comments",o),this.padOuter.find("#comments, #commentIcons").toggleClass("active",o),$("body").toggleClass("comments-active",o),$('iframe[name="ace_outer"]').contents().find("body").toggleClass("comments-active",o)}),$("#options-comments").trigger("change"),(browser.chrome||browser.firefox)&&(this.padInner.contents().on("copy",o=>{events.addTextOnClipboard(o,this.ace,this.padInner,!1,this.comments,this.commentReplies)}),this.padInner.contents().on("cut",o=>{events.addTextOnClipboard(o,this.ace,this.padInner,!0)}),this.padInner.contents().on("paste",o=>{events.saveCommentsAndReplies(o)}))},EpComments.prototype.findCommentText=function(e){return e.hasClass("sidebar-comment-reply")?e.find(".comment-text"):e.find(".compact-display-content .comment-text, .full-display-content .comment-title-wrapper .comment-text")},EpComments.prototype.collectCommentsAfterSomeIntervalsOfTime=async function(){await new Promise(o=>window.setTimeout(o,300)),this.collectComments();let e=Object.keys(this.comments).length;const t=$('iframe[name="ace_outer"]').contents();this.padOuter=t,this.padInner=t.find('iframe[name="ace_inner"]');let n=this.padInner.contents().find(".comment");e<=n.length||(await new Promise(o=>window.setTimeout(o,1e3)),this.collectComments(),e=Object.keys(this.comments).length,n=this.padInner.contents().find(".comment"),!(e<=n.length)&&(await new Promise(o=>window.setTimeout(o,3e3)),this.collectComments(),e=Object.keys(this.comments).length,n=this.padInner.contents().find(".comment"),!(e<=n.length)&&(await new Promise(o=>window.setTimeout(o,9e3)),this.collectComments())))},EpComments.prototype.findContainers=function(){const e=$('iframe[name="ace_outer"]').contents();this.padOuter=e,this.padInner=e.find('iframe[name="ace_inner"]'),this.outerBody=e.find("#outerdocbody")},EpComments.prototype.collectComments=function(e){const t=this,n=this.container,o=this.comments;this.padInner.contents().find(".comment").each(function(c){const a=$(this).attr("class"),l=/(?:^| )(c-[A-Za-z0-9]*)/.exec(a),r=l?l[1]:null;if(!r)return;t.padInner.contents().find("#innerdocbody").addClass("comments");const d=n.find(`#${r}`),p=o[r];p&&(p.data.changeFrom=parseMultiline(p.data.changeFrom),d.length===0&&t.insertComment(r,p.data,c),commentL10n.localize(d));const h=d.prev();let f=0;if(h.length!==0){const u=h.css("top"),g=h.innerHeight();f=parseInt(u)+g+30}d.css({top:f})});let i;this.container.on("mouseover",".sidebar-comment",c=>{clearTimeout(i),commentBoxes.highlightComment(c.currentTarget.id,c)}).on("mouseout",".sidebar-comment",c=>{i=setTimeout(()=>{commentBoxes.hideComment(c.currentTarget.id)},1e3)}),this.padInner.contents().on("mouseover",".comment",function(c){if(n.is(":visible")){clearTimeout(i);const m=t.commentIdOf(c);commentBoxes.highlightComment(m,c,$(this))}}),this.padInner.contents().on("click",".comment",function(c){const m=t.commentIdOf(c);commentBoxes.highlightComment(m,c,$(this))}),this.padInner.contents().on("mouseleave",".comment",c=>{!commentIcons.isCommentOpenedByClickOnIcon()&&n.is(":visible")&&(i=setTimeout(()=>{t.closeOpenedComment(c)},1e3))}),this.addListenersToCloseOpenedComment(),this.setYofComments(),e&&e()},EpComments.prototype.addListenersToCloseOpenedComment=function(){$(document).on("touchstart click",e=>{this.closeOpenedCommentIfNotOnSelectedElements(e)}),this.padOuter.find("html").on("touchstart click",e=>{this.closeOpenedCommentIfNotOnSelectedElements(e)}),this.padInner.contents().find("html").on("touchstart click",e=>{this.closeOpenedCommentIfNotOnSelectedElements(e)})},EpComments.prototype.closeOpenedComment=function(e){const t=this.commentIdOf(e);commentBoxes.hideComment(t)},EpComments.prototype.closeOpenedCommentIfNotOnSelectedElements=function(e){commentIcons.shouldNotCloseComment(e)||commentBoxes.shouldNotCloseComment(e)||this.closeOpenedComment(e)},EpComments.prototype.collectCommentReplies=function(e){$.each(this.commentReplies,(t,n)=>{const o=n.commentId;if(o){if(commentIcons.commentHasReply(o),$('iframe[name="ace_outer"]').contents().find(`#${t}`).length)return;n.replyId=t,n.text=n.text||"",n.date=moment(n.timestamp).fromNow(),n.formattedDate=new Date(n.timestamp).toISOString();const i=$("#replyTemplate").tmpl(n);n.author!==clientVars.userId&&$(i).find(".comment-edit").remove(),commentL10n.localize(i),$('iframe[name="ace_outer"]').contents().find(`#${o} .comment-replies-container`).append(i)}})},EpComments.prototype.commentIdOf=function(e){const t=e.currentTarget.classList,n=/(?:^| )(c-[A-Za-z0-9]*)/.exec(t);return n?n[1]:null},EpComments.prototype.insertContainers=function(){const e=$('iframe[name="ace_outer"]').contents().find("#outerdocbody");e.prepend($("<div>").addClass("comment-modal popup").append($("<div>").addClass("popup-content comment-modal-comment"))),e.prepend($("<div>").attr("id","comments")),this.container=this.padOuter.find("#comments")},EpComments.prototype.insertComment=function(e,t,n){let o=null;const s=this.container,i=s.find(".sidebar-comment").eq(n);t.commentId=e,t.reply=!0,o=$("#commentsTemplate").tmpl(t),o.find(".from-label")[0].dataset.l10nArgs=JSON.stringify({changeFrom:t.changeFrom,changeTo:t.changeTo}),t.author!==clientVars.userId&&$(o).find(".comment-actions-wrapper").addClass("hidden"),commentL10n.localize(o),n===0?o.prependTo(s):i.length===0?o.appendTo(s):i.before(o),commentIcons.addIcon(e,t)},EpComments.prototype.setYofComments=function(){const e=$('iframe[name="ace_outer"]').contents(),t=e.find('iframe[name="ace_inner"]'),n=this.getFirstOcurrenceOfCommentIds(),o=[];$.each(n,function(){const s=/(?:^| )(c-[A-Za-z0-9]*)/.exec(this.className);if(!s||!s[1])return;const i=e.find(`#${s[1]}`);let c=this.offsetTop;c+=parseInt(t.css("padding-top").split("px")[0]),c+=parseInt($(this).css("padding-top").split("px")[0]),s&&(commentBoxes.adjustTopOf(s[1],c),commentIcons.adjustTopOf(s[1],c),commentIcons.shouldShow(i)&&o.push(i))}),_.each(o,s=>{s.show()})},EpComments.prototype.getFirstOcurrenceOfCommentIds=function(){const t=$('iframe[name="ace_outer"]').contents().find('iframe[name="ace_inner"]').contents(),n=this.getUniqueCommentsId(t);return _.map(n,s=>t.find(`.${s}`).first().get(0))},EpComments.prototype.getUniqueCommentsId=function(e){const t=e.find(".comment"),n=_.map(t,s=>{const i=/(?:^| )(c-[A-Za-z0-9]*)/.exec(s.className);if(i&&i[1])return i[1]}),o=(s,i,c)=>c.indexOf(s)===i;return n.filter(o)},EpComments.prototype.allCommentsOnCorrectYPosition=function(){const n=$('iframe[name="ace_outer"]').contents().find('iframe[name="ace_inner"]').contents().find(".comment");let o=!0;return $.each(n,function(){const s=this.offsetTop,i=/(?:^| )(c-[A-Za-z0-9]*)/.exec(this.className);if(i&&i[1]&&!commentBoxes.isOnTop(i[1],s))return o=!1,!1}),o},EpComments.prototype.localizeExistingComments=function(){const e=this,t=this.padInner.contents().find(".comment"),n=this.comments;t.each((o,s)=>{const c=$(s).attr("class"),m=/(?:^| )(c-[A-Za-z0-9]*)/.exec(c),a=m?m[1]:null;if(a!=null){const l=e.container.find(`#${a}`),r=n[a];commentL10n.localize(l),r.data.date=moment(r.data.timestamp).fromNow(),r.data.formattedDate=new Date(r.data.timestamp).toISOString(),$(l).find(".comment-created-at").html(r.data.date)}})},EpComments.prototype.setComments=function(e){for(const[t,n]of Object.entries(e))this.setComment(t,n)},EpComments.prototype.setComment=function(e,t){const n=this.comments;t.date=moment(t.timestamp).fromNow(),t.formattedDate=new Date(t.timestamp).toISOString(),n[e]==null&&(n[e]={}),n[e].data=t},EpComments.prototype.setCommentReply=function(e){const t=this.commentReplies,n=e[0];t[n]=e[1]},EpComments.prototype.setCommentOrReplyNewText=function(e,t){this.comments[e]?this.comments[e].data.text=t:this.commentReplies[e]&&(this.commentReplies[e].text=t)},EpComments.prototype._send=async function(e,...t){return await new Promise((n,o)=>{this.socket.emit(e,...t,(s,i)=>{if(s!=null)return o(Object.assign(new Error(s.message),{name:s.name}));n(i)})})},EpComments.prototype.getComments=async function(){return(await this._send("getComments",{padId:this.padId})).comments},EpComments.prototype.getCommentReplies=async function(){return(await this._send("getCommentReplies",{padId:this.padId})).replies},EpComments.prototype.getCommentData=function(){const e={};return e.padId=this.padId,e.comment={},e.comment.author=clientVars.userId,e.comment.name=pad.myUserInfo.name,e.comment.timestamp=new Date().getTime(),e.comment.name===void 0&&(e.comment.name=clientVars.userAgent),e},EpComments.prototype.deleteComment=function(e){$('iframe[name="ace_outer"]').contents().find(`#${e}`).remove()};const cloneLine=e=>{const n=$('iframe[name="ace_outer"]').contents().find('iframe[name="ace_inner"]'),o=$(e.lineNode),s=o.clone(),i=$(n).offset().left,c=parseInt(n.css("padding-left")+o.offset().left),m=i+c||0;return n.contents().find("body").append(s),s.css({position:"absolute"}),s.css(o.offset()),s.css({left:m}),s.width(o.width()),s};let isHeading=function(e){const t=this.documentAttributeManager.getAttributesOnLine(e);for(let n=0;n<t.length;n++)if(t[n][0]==="heading"){const o=t[n][1];return n=t.length,o}return!1};const getXYOffsetOfRep=e=>{let t=e.selStart,n=e.selEnd;(t[0]>n[0]||t[0]===n[0]&&t[1]>n[1])&&(n=t,t=_.clone(t));let o=0;const s=n[1],i=n[0];t[0]===n[0]&&(o=t[1]);const c=$('iframe[name="ace_outer"]').contents().find('iframe[name="ace_inner"]'),m=e.lines.atIndex(t[0]),a=e.lines.atIndex(n[0]),l=cloneLine(a);let r=Security.escapeHTML($(a.lineNode).text()).split("");r.splice(s,0,"</span>"),r.splice(o,0,'<span id="selectWorker">'),r=r.join("");const d=isHeading(i);if(d&&(r=`<${d}>${r}</${d}>`),$(l).html(r),$(m.lineNode).length!==0){const p=$(l).find("#selectWorker");let h=p.offset().top+c.offset().top+parseInt(c.css("padding-top")),f=p.offset().left;return h+=p[0].offsetHeight,f<0&&(f=0),$(l).remove(),[f,h]}};EpComments.prototype.displayNewCommentForm=function(){const e={};this.ace.callWithAce(m=>{const a=m.ace_getRep();e.lines=a.lines,e.selStart=a.selStart,e.selEnd=a.selEnd},"saveCommentedSelection",!0);const n=this.getSelectedText(e);if(n.length===0){$.gritter.add({text:html10n.translations["ep_comments_page.add_comment.hint"]||"Please first select the text to comment"});return}this.createNewCommentFormIfDontExist(e),$("#newComment").find(".from-value").text(n);const s=this.getFirstElementSelected();this.isElementInViewport(s)||this.scrollViewportIfSelectedTextIsNotVisible(s);const c=getXYOffsetOfRep(e);newComment.showNewCommentPopup(c)},EpComments.prototype.scrollViewportIfSelectedTextIsNotVisible=function(e){const t=e.offsetTop,n=$('iframe[name="ace_outer"]').contents();n.find("#outerdocbody").scrollTop(t),n.find("#outerdocbody").parent().scrollTop(t)},EpComments.prototype.isElementInViewport=function(e){const t=e.getBoundingClientRect(),n=$('iframe[name="ace_outer"]').contents().find("#outerdocbody"),o=n.scrollTop()||n.parent().scrollTop(),s=t.top-o,i=t.bottom-o,c=$('iframe[name="ace_outer"]'),m=c.height(),a=this.getIntValueOfCSSProperty(c,"padding-top"),l=m-a,r=s<0,d=i>l;return!(r||d)},EpComments.prototype.getIntValueOfCSSProperty=function(e,t){const n=e.css(t);return parseInt(n)||0},EpComments.prototype.getFirstElementSelected=function(){let e;return this.ace.callWithAce(t=>{const n=t.ace_getRep(),s=`#${n.lines.atIndex(n.selStart[0]).key}`;e=$('iframe[name="ace_outer"]').contents().find('iframe[name="ace_inner"]').contents().find(s)},"getFirstElementSelected",!0),e[0]},EpComments.prototype.checkNoTextSelected=function(e){return e.selStart[0]===e.selEnd[0]&&e.selStart[1]===e.selEnd[1]},EpComments.prototype.createNewCommentFormIfDontExist=function(e){const t=this.getCommentData();t.changeFrom=parseMultiline(this.getSelectedText(e)),newComment.insertNewCommentPopupIfDontExist(t,(n,o)=>{n.changeTo&&(t.comment.changeFrom=n.changeFrom,t.comment.changeTo=n.changeTo),t.comment.text=n.text,this.saveComment(t,e)})},EpComments.prototype.getSelectedText=function(e){const t=[],n=this.getLastLine(e.selStart[0],e);for(let o=e.selStart[0];o<=n;++o){const s=e.lines.atIndex(o);if(e.selStart[0]>o||e.selStart[0]===o&&e.selStart[1]>=s.text.length||e.selEnd[0]<o||e.selEnd[0]===o&&e.selEnd[1]<=0)continue;const a=e.selStart[0]<o||e.selStart[1]<0?0:e.selStart[1],r=e.selEnd[0]>o||e.selEnd[1]>s.text.length?s.text.length:e.selEnd[1];t.push(s.text.substring(a===0&&this.lineHasMarker(s)?1:a,r))}return t.join(`
`)},EpComments.prototype.getLastLine=function(e,t){let n=t.selEnd[0];return n>e&&this.lastLineSelectedIsEmpty(t,n)&&n--,n},EpComments.prototype.lastLineSelectedIsEmpty=function(e,t){const n=e.lines.atIndex(t),o=this.lineHasMarker(n)?1:0;return e.selEnd[1]===o},EpComments.prototype.lineHasMarker=function(e){return e.lineMarker===1},EpComments.prototype.saveComment=async function(e,t){const n=await this._send("addComment",e);if(n==null)return;const[o,s]=n;s.commentId=o,this.ace.callWithAce(i=>{t=i.ace_getRep(),i.ace_performSelectionChange(t.selStart,t.selEnd,!0),i.ace_setAttributeOnSelection("comment",o)},"insertComment",!0),this.setComment(o,s),this.collectComments()},EpComments.prototype.saveCommentWithoutSelection=async function(e,t){const n=this.buildComments(t),o=await this._send("bulkAddComment",e,n);this.setComments(o),this.shouldCollectComment=!0},EpComments.prototype.buildComments=function(e){return _.map(e,(n,o)=>this.buildComment(o,n.data))},EpComments.prototype.buildComment=function(e,t){const n={};return n.padId=this.padId,n.commentId=e,n.text=t.text,n.changeTo=t.changeTo,n.changeFrom=t.changeFrom,n.name=t.name,n.timestamp=parseInt(t.timestamp),n},EpComments.prototype.getMapfakeComments=function(){return this.mapFakeComments},EpComments.prototype.saveCommentReplies=async function(e,t){const n=this.buildCommentReplies(t),o=await this._send("bulkAddCommentReplies",e,n);_.each(o,s=>{this.setCommentReply(s)}),this.shouldCollectComment=!0},EpComments.prototype.buildCommentReplies=function(e){return _.map(e,n=>this.buildCommentReply(n))},EpComments.prototype.buildCommentReply=function(e){const t={};return t.padId=this.padId,t.commentId=e.commentId,t.text=e.text,t.changeTo=e.changeTo,t.changeFrom=e.changeFrom,t.replyId=e.replyId,t.name=e.name,t.timestamp=parseInt(e.timestamp),t},EpComments.prototype.commentListen=function(){this.socket.on("pushAddCommentInBulk",async()=>{const t=await this.getComments();if(!$.isEmptyObject(t)){const n={};_.map(t,(o,s)=>{n[s]={},n[s].data=o}),this.comments=n,this.collectCommentsAfterSomeIntervalsOfTime()}})},EpComments.prototype.commentRepliesListen=function(){this.socket.on("pushAddCommentReply",async(e,t)=>{const n=await this.getCommentReplies();$.isEmptyObject(n)||(this.commentReplies=n,this.collectCommentReplies())})},EpComments.prototype.updateCommentBoxText=function(e,t){const n=this.container.parent().find(`[data-commentid='${e}']`);this.findCommentText(n).text(t)},EpComments.prototype.showChangeAsAccepted=function(e){const t=this,n=this.container.parent().find(`[data-commentid='${e}']`);n.closest(".sidebar-comment").find(".comment-container.change-accepted").addBack(".change-accepted").each(function(){$(this).removeClass("change-accepted");const o={commentId:$(this).attr("data-commentid"),padId:t.padId};t._send("revertChange",o)}),n.addClass("change-accepted")},EpComments.prototype.showChangeAsReverted=function(e){this.container.parent().find(`[data-commentid='${e}']`).removeClass("change-accepted")},EpComments.prototype.pushComment=function(e,t){const n=this.socket;n.on("textCommentUpdated",(o,s)=>{this.updateCommentBoxText(o,s)}),n.on("commentDeleted",o=>{this.deleteComment(o)}),n.on("changeAccepted",o=>{this.showChangeAsAccepted(o)}),n.on("changeReverted",o=>{this.showChangeAsReverted(o)}),e==="add"?n.on("pushAddComment",(o,s)=>{t(o,s)}):e==="addCommentReply"&&n.on("pushAddCommentReply",(o,s)=>{t(o,s)})};const hooks={postAceInit:async(e,t)=>{pad.plugins||(pad.plugins={});const n=new EpComments(t);await n.initDone,pad.plugins.ep_comments_page=n,$("#editorcontainerbox").hasClass("flex-layout")||$.gritter.add({title:"Error",text:"Ep_comments_page: Please upgrade to etherpad 1.8.3 for this plugin to work correctly",sticky:!0,class_name:"error"})},postToolbarInit:(e,t,n)=>(t.toolbar.registerCommand("addComment",()=>{pad.plugins.ep_comments_page.displayNewCommentForm()}),n()),aceEditEvent:(e,t)=>{pad.plugins||(pad.plugins={});const n=t.callstack.editEvent.eventType;if(n==="unmarkPreSelectedTextToComment"?pad.plugins.ep_comments_page.preCommentMarker.handleUnmarkText(t):n==="markPreSelectedTextToComment"&&pad.plugins.ep_comments_page.preCommentMarker.handleMarkText(t),!["setup","setBaseText","importText"].includes(n)&&(t.callstack.docTextChanged&&pad.plugins.ep_comments_page&&pad.plugins.ep_comments_page.setYofComments(),pad.plugins.ep_comments_page)){const o=pad.plugins.ep_comments_page.shouldCollectComment,s=t.callstack.domClean;o&&s&&pad.plugins.ep_comments_page.collectComments(()=>{pad.plugins.ep_comments_page.collectCommentReplies(),pad.plugins.ep_comments_page.shouldCollectComment=!1})}},aceAttribsToClasses:(e,t,n)=>t.key==="comment"&&t.value!=="comment-deleted"?n(["comment",t.value]):t.key===preCommentMark.MARK_CLASS&&t.value===clientVars.userId?n([preCommentMark.MARK_CLASS,t.value]):n(),aceEditorCSS:(e,t)=>cssFiles};exports.aceEditorCSS=hooks.aceEditorCSS,exports.postAceInit=hooks.postAceInit,exports.postToolbarInit=hooks.postToolbarInit,exports.aceAttribsToClasses=hooks.aceAttribsToClasses,exports.aceEditEvent=hooks.aceEditEvent;const getRepFromSelector=function(e,t){const n=this.documentAttributeManager,o=[],s=t.contents().find(e);return $.each(s,(i,c)=>{const m=[[],[]],a=$(c).closest("div"),l=$(a).prevAll("div").length;m[0][0]=l,m[1][0]=l;let r=0,d=!1;const p=n.getAttributesOnLine(l);$.each(p,(h,f)=>{f[0]==="lmkr"&&(d=!0)}),d&&r++,$(c).prevAll("span").each(function(){const h=$(this).text().length;r+=h}),m[0][1]=r,m[1][1]=m[0][1]+$(c).text().length,o.push(m)}),o};exports.aceInitialized=(e,t,n)=>{const o=t.editorInfo;return isHeading=isHeading.bind(t),o.ace_getRepFromSelector=getRepFromSelector.bind(t),o.ace_getCommentIdOnFirstPositionSelected=getCommentIdOnFirstPositionSelected.bind(t),o.ace_hasCommentOnSelection=hasCommentOnSelection.bind(t),n()};
}}["(module ep_comments_page/static/js/index.js)"],
});
